<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Quality Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); min-height: 100vh; color: white; }
        .card-custom { background: rgba(255,255,255,0.15); border-radius: 15px; backdrop-filter: blur(10px); }
        .card-custom:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .table { color: white; }
        .table thead { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold fs-3" th:href="@{/coffee}">
            <i class="bi bi-cup-straw"></i> JUKO COFFEE MANAGEMENT
        </a>
        <div class="d-flex align-items-center text-white">
            <a th:href="@{/coffee}" class="btn btn-outline-light me-2">Back to Coffee Hub</a>
            <a th:href="@{/dashboard}" class="btn btn-outline-light">Dashboard</a>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Quality Tracking</h1>
        <p class="lead fs-3">From wet mill to cupping – track every step</p>
    </div>

    <!-- Quality Record Form -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="card-custom p-4">
                <h3 class="text-center mb-4">Record Quality Data</h3>
                <form id="qualityForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label>Farm</label>
                            <select id="farmSelect" class="form-select" required>
                                <option value="">-- Select Farm --</option>
                                <option th:each="farm : ${farms}" th:value="${farm.id}" th:text="${farm.name} + ' - ' + ${farm.location}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Pulping Date</label>
                            <input type="date" id="pulpingDate" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label>Parchment Moisture (%)</label>
                            <input type="number" step="0.1" id="moisture" class="form-control" placeholder="e.g., 11.5">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label>Drying Days</label>
                            <input type="number" id="dryingDays" class="form-control" placeholder="e.g., 14">
                        </div>
                        <div class="col-md-3">
                            <label>Grade</label>
                            <select id="grade" class="form-select">
                                <option>AA</option>
                                <option>AB</option>
                                <option>PB</option>
                                <option>C</option>
                                <option>TT</option>
                                <option>UG</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Defects Observed</label>
                            <input type="text" id="defects" class="form-control" placeholder="e.g., black beans, foxy">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label>Cupping Score (0–100)</label>
                            <input type="number" step="0.25" min="0" max="100" id="cuppingScore" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>Cupping Notes</label>
                            <input type="text" id="cuppingNotes" class="form-control" placeholder="e.g., bright acidity, floral, chocolate">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" onclick="saveQualityRecord()" class="btn btn-success btn-lg w-100">
                                Save Quality Record
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label>General Notes</label>
                        <textarea id="generalNotes" class="form-control" rows="3" placeholder="Processing observations, weather during drying, etc."></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quality Records Table -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card-custom p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Quality Records</h3>
                    <button onclick="loadRecords()" class="btn btn-info">Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="qualityTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Farm</th>
                                <th>Pulping Date</th>
                                <th>Moisture %</th>
                                <th>Drying Days</th>
                                <th>Grade</th>
                                <th>Cupping</th>
                                <th>Defects</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let editingId = null;

window.onload = function() {
    document.getElementById('pulpingDate').valueAsDate = new Date();
    loadRecords();
};

function saveQualityRecord() {
    const farmId = document.getElementById('farmSelect').value;
    const pulpingDate = document.getElementById('pulpingDate').value;
    if (!farmId || !pulpingDate) {
        alert('Farm and pulping date are required');
        return;
    }

    const record = {
        id: editingId || undefined,
        farm: { id: farmId },
        pulpingDate: pulpingDate,
        parchmentMoisture: parseFloat(document.getElementById('moisture').value) || null,
        dryingDays: parseInt(document.getElementById('dryingDays').value) || null,
        grade: document.getElementById('grade').value || null,
        defects: document.getElementById('defects').value.trim() || null,
        cuppingScore: parseFloat(document.getElementById('cuppingScore').value) || null,
        cuppingNotes: document.getElementById('cuppingNotes').value.trim() || null,
        generalNotes: document.getElementById('generalNotes').value.trim() || null
    };

    const method = editingId ? 'PUT' : 'POST';
    const url = editingId ? `/api/quality-records/${editingId}` : '/api/quality-records';

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(record)
    })
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(() => {
        loadRecords();
        document.getElementById('qualityForm').reset();
        document.getElementById('pulpingDate').valueAsDate = new Date();
        editingId = null;
        alert('Quality record saved!');
    })
    .catch(() => alert('Error saving record'));
}

function loadRecords() {
    fetch('/api/quality-records')
        .then(res => res.json())
        .then(records => {
            const tbody = document.querySelector('#qualityTable tbody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No quality records yet</td></tr>';
                return;
            }

            const rows = records.map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${r.farm.name}</td>
                    <td>${r.pulpingDate}</td>
                    <td>${r.parchmentMoisture || '—'}</td>
                    <td>${r.dryingDays || '—'}</td>
                    <td><strong>${r.grade || '—'}</strong></td>
                    <td>${r.cuppingScore ? r.cuppingScore + ' – ' + (r.cuppingNotes || '') : '—'}</td>
                    <td>${r.defects || '—'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${r.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord(${r.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
        });
}

function editRecord(id) {
    fetch(`/api/quality-records/${id}`)
        .then(res => res.json())
        .then(r => {
            document.getElementById('farmSelect').value = r.farm.id;
            document.getElementById('pulpingDate').value = r.pulpingDate;
            document.getElementById('moisture').value = r.parchmentMoisture || '';
            document.getElementById('dryingDays').value = r.dryingDays || '';
            document.getElementById('grade').value = r.grade || '';
            document.getElementById('defects').value = r.defects || '';
            document.getElementById('cuppingScore').value = r.cuppingScore || '';
            document.getElementById('cuppingNotes').value = r.cuppingNotes || '';
            document.getElementById('generalNotes').value = r.generalNotes || '';
            editingId = id;
            document.querySelector('.card-custom').scrollIntoView({ behavior: 'smooth' });
        });
}

function deleteRecord(id) {
    if (confirm('Delete this quality record?')) {
        fetch(`/api/quality-records/${id}`, { method: 'DELETE' })
            .then(() => loadRecords());
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>