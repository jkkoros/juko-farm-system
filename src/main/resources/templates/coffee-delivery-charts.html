<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Cherry Delivery Charts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); min-height: 100vh; color: white; }
        .card-custom { background: rgba(255,255,255,0.15); border-radius: 15px; backdrop-filter: blur(10px); padding: 20px; }
        .chart-container { position: relative; height: 400px; margin: 20px 0; }
        canvas { background: rgba(255,255,255,0.9); border-radius: 10px; padding: 10px; }
        .controls { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; margin-bottom: 30px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold fs-3" th:href="@{/coffee}">
            <i class="bi bi-cup-straw"></i> JUKO COFFEE MANAGEMENT
        </a>
        <div class="d-flex align-items-center text-white">
            <a th:href="@{/coffee}" class="btn btn-outline-light me-2">Back to Coffee Hub</a>
            <a th:href="@{/dashboard}" class="btn btn-outline-light">Dashboard</a>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Cherry Delivery Charts</h1>
        <p class="lead fs-3">Visualize production patterns across seasons</p>
    </div>

    <!-- Controls -->
    <div class="controls text-center">
        <div class="row justify-content-center g-3">
            <div class="col-md-3">
                <label class="form-label fw-bold">Season</label>
                <select id="seasonSelect" class="form-select form-select-lg" onchange="loadAllCharts()">
                    <option th:each="s : ${seasons}" th:value="${s.seasonName}" th:text="${s.seasonName}"
                            th:selected="${s.id == selectedSeason.id}"></option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Daily Chart Start</label>
                <input type="date" id="startDate" class="form-control form-control-lg">
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Daily Chart End</label>
                <input type="date" id="endDate" class="form-control form-control-lg">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button onclick="loadAllCharts()" class="btn btn-success btn-lg w-100">
                    <i class="bi bi-arrow-clockwise me-2"></i> Refresh Charts
                </button>
            </div>
        </div>
        <div class="mt-3">
            <button onclick="clearDateFilter()" class="btn btn-secondary">Clear Date Filter</button>
        </div>
    </div>

    <!-- Tabs for Charts -->
    <ul class="nav nav-tabs justify-content-center mb-4" id="chartTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#monthly">Monthly</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#weekly">Weekly</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#daily">Daily</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="monthly">
            <div class="card-custom">
                <h3 class="text-center">Monthly Cherry Deliveries</h3>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="weekly">
            <div class="card-custom">
                <h3 class="text-center">Weekly Delivery Trends</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="daily">
            <div class="card-custom">
                <h3 class="text-center">Daily Delivery Patterns</h3>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Charts
let monthlyChart, weeklyChart, dailyChart;

window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;

    // Initialize charts
    const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
    monthlyChart = new Chart(ctxMonthly, getBarConfig('Monthly Deliveries (kg)'));

    const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
    weeklyChart = new Chart(ctxWeekly, getLineConfig('Weekly Trends (kg)'));

    const ctxDaily = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(ctxDaily, getLineConfig('Daily Patterns (kg)'));

    loadAllCharts();
};

function getBarConfig(title) {
    return {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Cherry (kg)', data: [], backgroundColor: '#28a745' }] },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: title, font: { size: 18 } } },
            scales: { y: { beginAtZero: true } }
        }
    };
}

function getLineConfig(title) {
    return {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Cherry (kg)', data: [], borderColor: '#28a745', tension: 0.1 }] },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: title, font: { size: 18 } } },
            scales: { y: { beginAtZero: true } }
        }
    };
}

function loadAllCharts() {
    const season = document.getElementById('seasonSelect').value;
    if (!season) return alert('Please select a season');

    loadMonthlyChart(season);
    loadWeeklyChart(season);
    loadDailyChart(season);
}

function loadMonthlyChart(season) {
    fetch(`/clerk/api/delivery-stats/monthly?season=${season}`)
        .then(res => res.json())
        .then(data => {
            const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const values = new Array(12).fill(0);
            data.forEach(item => {
                const monthIndex = new Date(item.month + '-01').getMonth();
                values[monthIndex] = item.totalKg;
            });
            monthlyChart.data.labels = labels;
            monthlyChart.data.datasets[0].data = values;
            monthlyChart.update();
        });
}

function loadWeeklyChart(season) {
    fetch(`/clerk/api/delivery-stats/weekly?season=${season}`)
        .then(res => res.json())
        .then(data => {
            const labels = data.map(item => `Week ${item.week}`);
            const values = data.map(item => item.totalKg);
            weeklyChart.data.labels = labels;
            weeklyChart.data.datasets[0].data = values;
            weeklyChart.update();
        });
}

function loadDailyChart(season) {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    let url = `/clerk/api/delivery-stats/daily?season=${season}`;
    if (start && end) url += `&start=${start}&end=${end}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const labels = data.map(item => item.date);
            const values = data.map(item => item.totalKg);
            dailyChart.data.labels = labels;
            dailyChart.data.datasets[0].data = values;
            dailyChart.update();
        });
}

function clearDateFilter() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    loadDailyChart(document.getElementById('seasonSelect').value);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>